<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>äººç”Ÿè¨­è¨ˆã‚µãƒã‚¤ãƒãƒ« | å­¦è²»ãƒ»è©³ç´°å†…è¨³ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --sidebar-width: 270px;
            --main-bg: #f4f7f9;
            --accent: #3498db;
            --invest: #27ae60;
            --danger: #e74c3c;
            --success: #2ecc71;
            --text: #2c3e50;
            --card-bg: #ffffff;
        }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; color: var(--text); }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar { width: var(--sidebar-width); background: var(--text); color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .sim-btn-container { padding: 25px 20px; background: #1a252f; border-bottom: 1px solid #34495e; }
        .btn-simulate { width:100%; padding:18px; background:var(--accent); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold; font-size: 1.1rem; box-shadow: 0 4px 0 #2980b9; transition: 0.1s; }
        .btn-simulate:active { transform: translateY(2px); box-shadow: 0 2px 0 #2980b9; }

        .tab-btn { background: none; border: none; color: #adb5bd; padding: 15px 20px; text-align: left; cursor: pointer; border-left: 4px solid transparent; width: 100%; font-size: 0.95rem; }
        .tab-btn.active { background: #34495e; color: white; border-left: 4px solid var(--accent); }
        .sub-tab { padding-left: 40px; font-size: 0.85rem; background: #243342; }

        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        .main-content { flex: 1; background: var(--main-bg); overflow-y: auto; padding: 30px; display: grid; grid-template-columns: 1fr 420px; gap: 25px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #eef0f2; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .section-title { font-size: 0.95rem; font-weight: bold; margin: 20px 0 12px 0; color: var(--accent); border-bottom: 2px solid #f1f3f5; padding-bottom: 8px; }

        /* å…¥åŠ›UI */
        .unit-input { position: relative; display: flex; align-items: center; margin-bottom: 10px; }
        .unit-input input, .unit-input select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .unit-man::after { content: "ä¸‡å††"; position: absolute; right: 15px; color: #888; font-size: 0.85rem; }
        .toggle-container { display: flex; gap: 10px; margin-bottom: 15px; }
        .toggle-btn { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; text-align: center; cursor: pointer; background: white; font-weight: bold; }
        .toggle-btn.active { background: var(--accent) !important; color: white !important; }

        /* ã‚¹ãƒ†ãƒƒãƒ‘ãƒ¼ */
        .stepper { display: flex; align-items: center; gap: 8px; background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 5px 10px; }
        .stepper button { background: #f1f3f5; border: none; width: 35px; height: 35px; cursor: pointer; border-radius: 6px; font-weight: bold; }

        /* ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š */
        .event-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1.5fr 40px; gap: 10px; background: #fff; padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; }

        /* çµæœãƒ†ãƒ¼ãƒ–ãƒ« */
        .result-table { width: 100%; border-collapse: collapse; background: white; }
        .result-table th { background: #f1f3f5; padding: 12px; font-size: 0.75rem; border-bottom: 2px solid #dee2e6; position: sticky; top: 0; }
        .result-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: right; font-size: 0.85rem; }
        .result-table tr:hover { background: #f0f7ff; cursor: pointer; }
        .val-plus { color: var(--success); font-weight: bold; }
        .val-minus { color: var(--danger); font-weight: bold; }

        /* P/Lè©³ç´° */
        .pl-card { position: sticky; top: 20px; border-top: 5px solid var(--accent); }
        .pl-table { width: 100%; border-collapse: collapse; }
        .pl-table td { padding: 12px 5px; border-bottom: 1px solid #f8f9fa; font-size: 0.9rem; }
        .pl-category { color: #7f8c8d; font-size: 0.75rem; font-weight: bold; background: #f8f9fa; padding: 5px 10px !important; }
        .pl-val { text-align: right; font-weight: bold; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sim-btn-container">
        <button class="btn-simulate" onclick="simulate()">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ</button>
    </div>
    <button class="tab-btn active" onclick="openTab(event, 'basic')">ğŸ  åŸºæœ¬è¨­å®š</button>
    <div class="sub-tab-container">
        <button class="tab-btn sub-tab" onclick="openTab(event, 'detailIncome')">â”œ åå…¥è©³ç´° (å¹´é½¢åˆ¥)</button>
        <button class="tab-btn sub-tab" onclick="openTab(event, 'detailLiving')">â”œ ç”Ÿæ´»è²»ãƒ»å­¦è²»</button>
        <button class="tab-btn sub-tab" onclick="openTab(event, 'detailCar')">â”œ è‡ªå‹•è»Šè¨­å®š</button>
        <button class="tab-btn sub-tab" onclick="openTab(event, 'detailEvent')">â”” ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆ</button>
    </div>
    <div class="sub-tab-container" style="border-top:1px solid #34495e;">
        <button id="navInvest" class="tab-btn sub-tab" onclick="openTab(event, 'detailInvest')" style="display:none;">ğŸ’° è³‡ç”£é‹ç”¨è©³ç´°</button>
    </div>
</div>

<div class="main-content">
    <div class="config-area">
        <div id="basic" class="tab-content active">
            <h1>åŸºæœ¬è¨­å®š</h1>
            <div class="card">
                <div class="section-title">ç¾åœ¨ã®çŠ¶æ³</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div><label>ç¾åœ¨ã®å¹´é½¢</label><input type="number" id="baseAge" value="25" class="unit-input"></div>
                    <div><label>åˆæœŸç¾é‡‘</label><div class="unit-input unit-man"><input type="number" id="baseInitialCash" value="100"></div></div>
                    <div><label>åˆæœŸæŠ•è³‡é¡</label><div class="unit-input unit-man"><input type="number" id="baseInitialInvest" value="0"></div></div>
                </div>

                <div class="section-title">å¹´åè¨­å®š</div>
                <div class="toggle-container">
                    <div id="incFixed" class="toggle-btn active" onclick="setIncomeMode('fixed')">ä¸€æ‹¬è¨­å®š</div>
                    <div id="incVar" class="toggle-btn" onclick="setIncomeMode('variable')">å¹´é½¢åˆ¥è©³ç´°</div>
                </div>
                <div id="fixedIncomeBox" class="unit-input unit-man"><input type="number" id="baseSalaryBasic" value="400"></div>

                <div class="section-title">ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«</div>
                <div class="toggle-container">
                    <div id="mOff" class="toggle-btn active" onclick="setMarriage(false)">ç‹¬èº«</div>
                    <div id="mOn" class="toggle-btn" onclick="setMarriage(true)">çµå©š</div>
                </div>
                <div id="marriedPanel" style="display:none; background:#f0f7ff; padding:20px; border-radius:12px; border: 1px dashed var(--accent); margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                        <span style="font-weight:bold;">ğŸ’ çµå©šãƒ»è‚²å…</span>
                        <button id="stdModeBtn" class="toggle-btn" style="flex:none; width:180px; font-size:0.75rem; padding:8px;" onclick="toggleStandardMode()">æ¨™æº–ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆï¼šOFF</button>
                    </div>

                    <div style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:15px;">
                        <div><label>çµå©šå¹´é½¢</label><input type="number" id="mAge" value="30" style="width:70px; padding:10px; border-radius:8px; border:1px solid #ddd;"></div>
                        <div><label>å­ä¾›ã®æ•°</label><select id="childCount" onchange="updateChildInputs()" style="padding:10px; border-radius:8px; border:1px solid #ddd;"></select></div>
                        <div style="flex:1;">
                            <label>é¤Šè‚²è²»/äºº(æœˆ)</label>
                            <div class="stepper">
                                <button onclick="adjChildCost(-1)">-</button>
                                <input type="number" id="childCost" value="8" readonly>
                                <button onclick="adjChildCost(1)">+</button>
                            </div>
                        </div>
                    </div>

                    <div id="eduCostArea" style="display:none; border-top:1px solid #dcebf7; padding-top:15px;">
                        <span style="font-size:0.9rem; font-weight:bold; color:#2980b9;">ğŸ« å­¦è²»è¨­å®š (é¤Šè‚²è²»ã¨ã¯åˆ¥ã«åŠ ç®—)</span>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:10px;">
                            <div><label>é«˜æ ¡å­¦è²»(å¹´)</label><div class="unit-input unit-man"><input type="number" id="eduHigh" value="20"></div></div>
                            <div><label>å¤§å­¦å­¦è²»(å¹´)</label><div class="unit-input unit-man"><input type="number" id="eduUni" value="120"></div></div>
                        </div>
                    </div>
                </div>

                <div class="section-title">è³‡ç”£é‹ç”¨</div>
                <div class="toggle-container">
                    <div id="iOff" class="toggle-btn active" onclick="setInvest(false)">ã—ãªã„</div>
                    <div id="iOn" class="toggle-btn" onclick="setInvest(true)">ã™ã‚‹</div>
                </div>
                <div id="investBasicBox" style="display:none; background:#e3f2fd; padding:15px; border-radius:12px;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div><label>æ¯æœˆã®ç©ç«‹é¡</label><div class="unit-input unit-man"><input type="number" id="investM" value="5"></div></div>
                        <div><label>æƒ³å®šåˆ©å›ã‚Š(%)</label><input type="number" id="investRate" value="5"></div>
                    </div>
                    <p style="font-size:0.8rem; color:var(--accent); margin-top:5px;">ğŸ‘‰ è©³ç´°ã¯å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œè³‡ç”£é‹ç”¨è©³ç´°ã€ã‚¿ãƒ–ã¸</p>
                </div>
            </div>

            <div id="resultArea" style="display:none; margin-top:30px; border-top:3px solid var(--accent); padding-top:20px;">
                <h1 style="color:var(--text); text-align:center;">ğŸ“Š ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</h1>
                <div id="deadAlert"></div>
                <div class="card">
                    <canvas id="mainChart" style="max-height:350px;"></canvas>
                </div>
                <div class="card">
                    <div class="section-title">1å¹´ã”ã¨ã®è©³ç´°æ¨ç§»</div>
                    <table class="result-table">
                        <thead><tr><th>å¹´é½¢</th><th>é¡é¢å¹´å</th><th>æ‰‹å–(å¹´)</th><th>æ”¯å‡º(æœˆå¹³å‡)</th><th>ç¾é‡‘æ®‹é«˜</th><th>æŠ•è³‡æ®‹é«˜</th><th>ç·è³‡ç”£</th></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="detailInvest" class="tab-content">
            <h1>è³‡ç”£é‹ç”¨ã®è©³ç´°è¨­å®š</h1>
            <div class="card">
                <div class="section-title">ç©ã¿ç«‹ã¦è¨­å®š</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div><label>ç©ç«‹çµ‚äº†å¹´é½¢</label><input type="number" id="investEndAge" value="60" class="unit-input"></div>
                    <div><label>æ¯æœˆã®ç©ç«‹é¡</label><div class="unit-input unit-man"><input type="number" id="investM_Detail" value="5" oninput="document.getElementById('investM').value=this.value"></div></div>
                </div>
                <div class="section-title">é‹ç”¨ãƒ»å–ã‚Šå´©ã—è¨­å®š</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div><label>å¹´åˆ©å›ã‚Š(%)</label><input type="number" id="investRate_Detail" value="5" class="unit-input" oninput="document.getElementById('investRate').value=this.value"></div>
                    <div><label>å–ã‚Šå´©ã—é–‹å§‹å¹´é½¢</label><input type="number" id="withdrawStartAge" value="65" class="unit-input"></div>
                </div>
                <div style="margin-top:10px;">
                    <label>å¹´é–“å–ã‚Šå´©ã—ç‡(%)</label>
                    <input type="number" id="withdrawRate" value="4" style="width:100px; padding:10px; border-radius:8px; border:1px solid #ddd;">
                </div>
            </div>
        </div>

        <div id="detailIncome" class="tab-content">
            <h1>å¹´é½¢åˆ¥å¹´åã®è¨­å®š</h1>
            <div class="card"><div id="salaryGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:12px;"></div>
            <div class="section-title">å®šå¹´ãƒ»é€€è·é‡‘ãƒ»å¹´é‡‘</div>
            <div style="display:flex; gap:15px; flex-wrap:wrap;">
                <div style="flex:1;"><label>å®šå¹´å¹´é½¢</label><input type="number" id="retireAge" value="65" class="unit-input"></div>
                <div style="flex:1;"><label>é€€è·é‡‘</label><div class="unit-input unit-man"><input type="number" id="retirementPay" value="2000"></div></div>
                <div style="flex:1;"><label>å¹´é‡‘å—çµ¦é–‹å§‹</label><input type="number" id="pensionAge" value="65" class="unit-input"></div>
                <div style="flex:1;"><label>å¹´é‡‘æœˆé¡(æ‰‹å–)</label><div class="unit-input unit-man"><input type="number" id="pensionMonthly" value="20"></div></div>
            </div>
            </div>
        </div>

        <div id="detailCar" class="tab-content">
            <h1>è‡ªå‹•è»Šè¨­å®š</h1>
            <div class="card">
                <div class="toggle-container">
                    <div id="carOff" class="toggle-btn active" onclick="setCar(false)">æ‰€æœ‰ã—ãªã„</div>
                    <div id="carOn" class="toggle-btn" onclick="setCar(true)">æ‰€æœ‰ã™ã‚‹</div>
                </div>
                <div id="carPanel" style="display:none;">
                    <label>è»Šä¸¡è³¼å…¥äºˆç®—</label><div class="unit-input unit-man"><input type="number" id="carPrice" value="300"></div>
                    <label>è²·ã„æ›¿ãˆã‚µã‚¤ã‚¯ãƒ«(å¹´)</label><input type="number" id="carCycle" value="10" class="unit-input">
                    <label>ç¶­æŒè²»/æœˆï¼ˆç‡ƒæ–™ãƒ»ä¿é™ºãƒ»ç¨é‡‘ç­‰ï¼‰</label><div class="unit-input unit-man"><input type="number" id="carRunM" value="4"></div>
                </div>
            </div>
        </div>

        <div id="detailLiving" class="tab-content">
            <h1>ç”Ÿæ´»è²»ãƒ»å­¦è²»</h1>
            <div class="card">
                <label>ç‹¬èº«æ™‚ã®ç”Ÿæ´»è²»(æœˆ)</label><div class="unit-input unit-man"><input type="number" id="baseLiving" value="20"></div>
                <label>çµå©šå¾Œã®ç”Ÿæ´»è²»(æœˆ)</label><div class="unit-input unit-man"><input type="number" id="marriedLiving" value="30"></div>
                <div id="childBirthSettings"></div>
            </div>
        </div>

        <div id="detailEvent" class="tab-content">
            <h1>ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆ</h1>
            <div class="card">
                <div style="background:#e3f2fd; padding:10px; border-radius:8px; margin-bottom:10px; font-size:0.9rem; color:var(--text);">
                    â„¹ï¸ <strong>å…¥åŠ›æ–¹æ³•</strong>ï¼šå·¦ã‹ã‚‰é †ã« [ã‚¤ãƒ™ãƒ³ãƒˆå] [ç™ºç”Ÿå¹´é½¢] [è²»ç”¨(ä¸‡å††)] [ç™ºç”Ÿé »åº¦] ã§ã™ã€‚
                </div>
                <div id="eventList"></div>
                <button class="btn-simulate" style="background:var(--success); margin-top:15px;" onclick="addEventRow()">+ ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ </button>
            </div>
        </div>
    </div>

    <div class="analysis-area">
        <div id="plCard" class="card pl-card" style="display:none;">
            <h3 style="text-align:center; margin-bottom:15px;">ğŸ“ <span id="plAgeText">--æ­³</span>ã®å®¶è¨ˆè©³ç´°</h3>
            <table class="pl-table">
                <tr><td class="pl-category" colspan="2">åå…¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³</td></tr>
                <tr><td>é¡é¢æœˆå</td><td class="pl-val" id="plGross">0ä¸‡</td></tr>
                <tr><td>ç¨ãƒ»ç¤¾ä¿å¼•å»(æ¨è¨ˆ)</td><td class="pl-val val-minus" id="plTax">0ä¸‡</td></tr>
                <tr><td>é‹ç”¨å–ã‚Šå´©ã—é¡</td><td class="pl-val val-plus" id="plWithdraw">0ä¸‡</td></tr>
                <tr style="background:#e8f4fd;"><td><strong>æ‰‹å–ã‚Šæœˆå</strong></td><td class="pl-val val-plus" id="plNet">0ä¸‡</td></tr>

                <tr><td class="pl-category" colspan="2">æ”¯å‡ºã‚»ã‚¯ã‚·ãƒ§ãƒ³</td></tr>
                <tr><td>åŸºæœ¬ç”Ÿæ´»è²»</td><td class="pl-val val-minus" id="plLiving">0ä¸‡</td></tr>
                <tr id="plCarRow"><td>è‡ªå‹•è»Šã‚³ã‚¹ãƒˆ</td><td class="pl-val val-minus" id="plCar">0ä¸‡</td></tr>
                <tr id="plChildRow"><td>é¤Šè‚²è²»(ç”Ÿæ´»è²»)</td><td class="pl-val val-minus" id="plChild">0ä¸‡</td></tr>
                <tr id="plEduRow"><td>æ•™è‚²è²»(å­¦è²»)</td><td class="pl-val val-minus" id="plEdu">0ä¸‡</td></tr>
                <tr id="plInvestRow"><td>ç©ç«‹æŠ•è³‡</td><td class="pl-val val-minus" id="plInvSpend">0ä¸‡</td></tr>
                <tr><td>ã‚¤ãƒ™ãƒ³ãƒˆæŒ‰åˆ†é¡</td><td class="pl-val val-minus" id="plEvent">0ä¸‡</td></tr>

                <tr style="border-top:2px solid #333; background:#f8f9fa;"><td><strong>æœ€çµ‚åæ”¯ï¼ˆè²¯é‡‘ï¼‰</strong></td><td class="pl-val" id="plTotalNet">0ä¸‡</td></tr>
            </table>
            <div id="plEventDetail" style="font-size:0.75rem; color:#666; margin-top:12px; padding:10px; background:#fdfdfe; border:1px solid #eee;"></div>
        </div>
    </div>
</div>

<script>
let chartMain = null;
let config = { isMarried: false, isInvest: false, isCar: false, incomeMode: 'fixed', isStd: false };
const defaultSalaries = { 20:400, 25:400, 30:600, 35:700, 40:750, 45:800, 50:850, 55:900, 60:450, 65:400, 70:0 };

function init() {
    const cs = document.getElementById('childCount');
    for(let i=0; i<=10; i++) cs.innerHTML += `<option value="${i}">${i}äºº</option>`;
    const grid = document.getElementById('salaryGrid');
    for(let a=20; a<=70; a+=5) {
        grid.innerHTML += `<div>${a}æ­³ã€œ<div class="unit-input unit-man"><input type="number" class="s-input" data-age="${a}" value="${defaultSalaries[a]||0}"></div></div>`;
    }
    updateChildInputs();
}

function formatCurrency(val) {
    if(val >= 10000) {
        const oku = Math.floor(val / 10000);
        const man = Math.round(val % 10000);
        return `${oku}å„„${man > 0 ? man + 'ä¸‡' : ''}å††`;
    }
    return Math.round(val) + "ä¸‡å††";
}

function setIncomeMode(m) {
    config.incomeMode = m;
    document.getElementById('incFixed').classList.toggle('active', m==='fixed');
    document.getElementById('incVar').classList.toggle('active', m==='variable');
    document.getElementById('fixedIncomeBox').style.display = m==='fixed' ? 'flex' : 'none';
}

function setMarriage(v) {
    config.isMarried = v;
    document.getElementById('mOn').classList.toggle('active', v);
    document.getElementById('mOff').classList.toggle('active', !v);
    document.getElementById('marriedPanel').style.display = v ? 'block' : 'none';
    if(v && config.isStd) applyStandardEvents();
    else if(!v) document.getElementById('eventList').innerHTML = "";
    updateChildInputs();
}

function setInvest(v) {
    config.isInvest = v;
    document.getElementById('iOn').classList.toggle('active', v);
    document.getElementById('iOff').classList.toggle('active', !v);
    document.getElementById('investBasicBox').style.display = v ? 'block' : 'none';
    document.getElementById('navInvest').style.display = v ? 'block' : 'none';
}

function setCar(v) {
    config.isCar = v;
    document.getElementById('carOn').classList.toggle('active', v);
    document.getElementById('carOff').classList.toggle('active', !v);
    document.getElementById('carPanel').style.display = v ? 'block' : 'none';
}

function toggleStandardMode() {
    config.isStd = !config.isStd;
    document.getElementById('stdModeBtn').innerText = config.isStd ? "æ¨™æº–ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆï¼šON" : "æ¨™æº–ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆï¼šOFF";
    document.getElementById('stdModeBtn').classList.toggle('active', config.isStd);
    if(config.isStd && config.isMarried) applyStandardEvents();
}

function applyStandardEvents() {
    const ma = parseInt(document.getElementById('mAge').value);
    const list = document.getElementById('eventList');
    list.innerHTML = "";
    addEventRow("çµå©šå¼", ma, 350, 0);
    addEventRow("å®¶æ—æ—…è¡Œ", ma, 10, 12);
}

function addEventRow(n="", a=30, c=0, f=0) {
    const div = document.createElement('div'); div.className = 'event-row';
    div.style = "display:grid; grid-template-columns: 2fr 1fr 1fr 1fr 30px; gap:5px; margin-bottom:5px;";
    div.innerHTML = `<input type="text" class="ev-n" value="${n}"><input type="number" class="ev-a" value="${a}"><input type="number" class="ev-c" value="${c}"><select class="ev-f"><option value="0" ${f==0?'selected':''}>1å›</option><option value="12" ${f==12?'selected':''}>æ¯å¹´</option><option value="120" ${f==120?'selected':''}>10å¹´æ¯</option></select><button onclick="this.parentElement.remove()" style="border:none;background:none;color:red;">Ã—</button>`;
    document.getElementById('eventList').appendChild(div);
}

function adjChildCost(v) {
    const input = document.getElementById('childCost');
    input.value = Math.max(0, parseInt(input.value) + v);
}

function updateChildInputs() {
    const count = config.isMarried ? parseInt(document.getElementById('childCount').value) : 0;
    const box = document.getElementById('childBirthSettings');
    const eduArea = document.getElementById('eduCostArea');

    eduArea.style.display = count > 0 ? 'block' : 'none';
    box.innerHTML = count > 0 ? '<div class="section-title">å­ä¾›ã®èª•ç”Ÿæ™‚å¹´é½¢è¨­å®š</div>' : '';

    const ma = parseInt(document.getElementById('mAge').value);
    for(let i=1; i<=count; i++) {
        box.innerHTML += `<div style="margin-bottom:10px;"><label>${i}äººç›®ã®èª•ç”Ÿæ™‚(è¦ªã®å¹´é½¢)</label><input type="number" class="c-birth" value="${ma + (i*2)}" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;"></div>`;
    }
}

function simulate() {
    document.getElementById('resultArea').style.display = 'block';
    openTab({currentTarget: document.querySelector('button[onclick="openTab(event, \'basic\')"]')}, 'basic');

    const startAge = parseInt(document.getElementById('baseAge').value);
    let cash = parseFloat(document.getElementById('baseInitialCash').value) || 0;
    let inv = (config.isInvest) ? parseFloat(document.getElementById('baseInitialInvest').value) : 0;
    const retAge = parseInt(document.getElementById('retireAge').value);
    const penAge = parseInt(document.getElementById('pensionAge').value);
    const penVal = parseFloat(document.getElementById('pensionMonthly').value);

    const results = [];
    let deadAge = null;

    // é¤Šè‚²è²»ãƒ»å­¦è²»è¨ˆç®—ç”¨
    const childC = config.isMarried ? parseInt(document.getElementById('childCount').value) : 0;
    const childCostM = parseFloat(document.getElementById('childCost').value);
    const eduHighY = parseFloat(document.getElementById('eduHigh').value);
    const eduUniY = parseFloat(document.getElementById('eduUni').value);

    const mAge = parseInt(document.getElementById('mAge').value);
    let birthAges = [];
    const birthInputs = document.querySelectorAll('.c-birth');
    if(birthInputs.length > 0) {
        birthAges = Array.from(birthInputs).map(i => parseInt(i.value));
    } else {
        for(let i=1; i<=childC; i++) birthAges.push(mAge + i*2);
    }

    for(let a=startAge; a<=100; a++) {
        let gross = 0;
        if(a < retAge) {
            if(config.incomeMode === 'fixed') gross = parseFloat(document.getElementById('baseSalaryBasic').value);
            else { document.querySelectorAll('.s-input').forEach(i => { if(a >= parseInt(i.dataset.age)) gross = parseFloat(i.value); }); }
        }

        let netM = calculateNetM(gross);
        if(a >= penAge) netM += penVal;

        let livM = (config.isMarried && a >= mAge) ? parseFloat(document.getElementById('marriedLiving').value) : parseFloat(document.getElementById('baseLiving').value);
        let carM = config.isCar ? parseFloat(document.getElementById('carRunM').value) : 0;

        // é¤Šè‚²è²»ï¼ˆç”Ÿæ´»è²»ï¼‰ã¨å­¦è²»ã®è¨ˆç®—
        let chiM = 0;
        let eduTotalY = 0;

        if(config.isMarried) {
            birthAges.forEach(b => {
                let cAge = a - b;
                // é¤Šè‚²è²»: 0æ­³ã€œ22æ­³(èª•ç”Ÿæ—¥å‰)ã¾ã§
                if(cAge >= 0 && cAge < 22) chiM += childCostM;

                // å­¦è²»: é«˜æ ¡(16,17,18æ­³) å¤§å­¦(19,20,21,22æ­³) â€»ç°¡æ˜“çš„ãªå¹´é½¢åˆ¤å®š
                if(cAge >= 15 && cAge <= 17) eduTotalY += eduHighY;
                if(cAge >= 18 && cAge <= 21) eduTotalY += eduUniY;
            });
        }

        let invM = 0; let withdrawM = 0;
        if(config.isInvest) {
            if(a < parseInt(document.getElementById('investEndAge').value)) invM = parseFloat(document.getElementById('investM').value);
            if(a >= parseInt(document.getElementById('withdrawStartAge').value)) {
                let yearlyWithdraw = inv * (parseFloat(document.getElementById('withdrawRate').value) / 100);
                withdrawM = yearlyWithdraw / 12;
                inv -= yearlyWithdraw;
            }
            inv *= (1 + parseFloat(document.getElementById('investRate').value) / 100);
            inv += (invM * 12);
        }

        let evY = 0; let activeEvs = [];
        document.querySelectorAll('.event-row').forEach(row => {
            const age = parseInt(row.children[1].value);
            const cost = parseFloat(row.children[2].value);
            const freq = parseInt(row.children[3].value);
            if((freq === 0 && a === age) || (freq > 0 && a >= age && (a-age)*12 % freq === 0)) {
                evY += cost; activeEvs.push(row.children[0].value);
            }
        });
        if(config.isCar && (a-startAge) % parseInt(document.getElementById('carCycle').value) === 0) {
            evY += parseFloat(document.getElementById('carPrice').value); activeEvs.push("è»Šè²·æ›¿");
        }

        let eduM = eduTotalY / 12; // æœˆæ¬¡æ›ç®—
        let balanceM = (netM + withdrawM) - (livM + carM + chiM + eduM + invM + (evY/12));
        cash += (balanceM * 12);
        if(a === retAge) cash += parseFloat(document.getElementById('retirementPay').value);
        if(cash < 0 && !deadAge) deadAge = a;

        results.push({ age: a, cash, inv, balanceM, netM, withdrawM, grossM: Math.round(gross/12), livM, carM, chiM, eduM, invM, evY, activeEvs });
    }
    renderResult(results, deadAge);
}

function calculateNetM(g) {
    if(g<=0) return 0;
    let n = g <= 400 ? g*0.8 : (g <= 750 ? 320+(g-400)*0.72 : 572+(g-750)*0.65);
    return Math.round(n/12);
}

function renderResult(data, deadAge) {
    const alertBox = document.getElementById('deadAlert');
    alertBox.innerHTML = deadAge ?
        `<div class="card" style="border-left:10px solid var(--danger);"><h2 style="color:var(--danger); margin:0;">âš ï¸ ${deadAge}æ­³ã§è³‡é‡‘æ¯æ¸‡</h2><p>ç¾é‡‘ãŒåº•ã‚’ã¤ãã¾ã—ãŸã€‚æ”¯å‡ºã®è¦‹ç›´ã—ãŒå¿…è¦ã§ã™ã€‚</p></div>` :
        `<div class="card" style="border-left:10px solid var(--success);"><h2 style="color:var(--success); margin:0;">âœ… 100æ­³ã¾ã§å®‰æ³°</h2><p>ç¾é‡‘ãƒ»è³‡ç”£ã¨ã‚‚ã«å®‰å®šã—ã¦ã„ã¾ã™ã€‚</p></div>`;

    document.getElementById('plCard').style.display = 'block';

    if(chartMain) chartMain.destroy();
    chartMain = new Chart(document.getElementById('mainChart'), {
        type: 'line',
        data: {
            labels: data.map(d=>d.age),
            datasets: [
                { label: 'ç¾é‡‘', data: data.map(d=>d.cash), borderColor: '#3498db', backgroundColor: '#3498db', fill: false, tension: 0.1 },
                { label: 'ç·è³‡ç”£(ç¾é‡‘+æŠ•è³‡)', data: data.map(d=>d.cash+d.inv), borderColor: '#2ecc71', backgroundColor: '#2ecc71', fill: false, tension: 0.1 }
            ]
        },
        options: {
            scales: {
                x: { title: { display: true, text: 'å¹´é½¢ (æ­³)' } },
                y: { title: { display: true, text: 'é‡‘é¡ (ä¸‡å††)' } }
            },
            interaction: { mode: 'index', intersect: false }
        }
    });

    document.getElementById('tableBody').innerHTML = data.map(d => `
        <tr onclick="showPL(${JSON.stringify(d).replace(/"/g, '&quot;')})">
            <td>${d.age}æ­³</td>
            <td>${d.grossM*12}ä¸‡</td>
            <td>${d.netM*12}ä¸‡</td>
            <td>${Math.round(d.livM+d.carM+d.chiM+d.eduM+(d.evY/12))}ä¸‡</td>
            <td style="color:${d.cash<0?'red':'inherit'}">${Math.round(d.cash)}ä¸‡</td>
            <td>${Math.round(d.inv)}ä¸‡</td>
            <td><strong>${formatCurrency(d.cash+d.inv)}</strong></td>
        </tr>`).join('');
    showPL(data[0]);
}

function showPL(d) {
    document.getElementById('plAgeText').innerText = d.age + "æ­³";
    document.getElementById('plGross').innerText = d.grossM + "ä¸‡";
    document.getElementById('plTax').innerText = "-" + (d.grossM - d.netM) + "ä¸‡";
    document.getElementById('plWithdraw').innerText = "+" + Math.round(d.withdrawM) + "ä¸‡";
    document.getElementById('plNet').innerText = Math.round(d.netM + d.withdrawM) + "ä¸‡";
    document.getElementById('plLiving').innerText = "-" + d.livM + "ä¸‡";
    document.getElementById('plCar').innerText = "-" + d.carM + "ä¸‡";
    document.getElementById('plChild').innerText = "-" + d.chiM + "ä¸‡";
    document.getElementById('plEdu').innerText = "-" + Math.round(d.eduM) + "ä¸‡";
    document.getElementById('plInvSpend').innerText = "-" + d.invM + "ä¸‡";
    document.getElementById('plEvent').innerText = "-" + Math.round(d.evY/12) + "ä¸‡";
    const total = document.getElementById('plTotalNet');
    total.innerText = (d.balanceM>=0?"+":"") + Math.round(d.balanceM) + "ä¸‡";
    total.style.color = d.balanceM>=0?"var(--success)":"var(--danger)";
    document.getElementById('plEventDetail').innerHTML = d.activeEvs.length ? `ã‚¤ãƒ™ãƒ³ãƒˆ: ${d.activeEvs.join(', ')}` : "ç‰¹è¨˜ãªã—";
}

function openTab(e, id) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(e && e.currentTarget) e.currentTarget.classList.add('active');
    else if(id === 'basic') document.querySelector('button[onclick="openTab(event, \'basic\')"]').classList.add('active');
}

init();
</script>
</body>
</html>
