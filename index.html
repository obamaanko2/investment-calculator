<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>äººç”Ÿè¨­è¨ˆã‚µãƒã‚¤ãƒãƒ«</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --sidebar-width: 250px;
            --main-bg: #f8f9fa;
            --accent: #3498db;
            --danger: #e74c3c;
            --success: #2ecc71;
            --text: #2c3e50;
            --card-bg: #ffffff;
        }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; color: var(--text); }
        .sidebar { width: var(--sidebar-width); background: var(--text); color: white; display: flex; flex-direction: column; padding-top: 20px; flex-shrink: 0; }
        .tab-btn { background: none; border: none; color: #adb5bd; padding: 15px 20px; text-align: left; cursor: pointer; border-left: 4px solid transparent; transition: 0.3s; font-size: 0.9rem; width: 100%; }
        .tab-btn:hover { background: #3e5871; color: white; }
        .tab-btn.active { background: #34495e; color: white; border-left: 4px solid var(--accent); }
        .sub-tab-container { background: #2c3e50; }
        .sub-tab { padding-left: 40px; font-size: 0.85rem; background: #243342; }
        .main-content { flex: 1; background: var(--main-bg); overflow-y: auto; padding: 30px; display: grid; grid-template-columns: 1fr 400px; gap: 25px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        .section-title { font-size: 0.95rem; font-weight: bold; margin: 20px 0 10px 0; color: var(--accent); border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .unit-input { position: relative; display: flex; align-items: center; margin-bottom: 8px; }
        .unit-input input, .unit-input select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .unit-man::after { content: "ä¸‡å††"; position: absolute; right: 12px; font-size: 0.8rem; color: #888; }
        .unit-percent::after { content: "%"; position: absolute; right: 12px; font-size: 0.8rem; color: #888; }
        .disabled-field { background-color: #f1f1f1 !important; color: #aaa !important; cursor: not-allowed; opacity: 0.5; pointer-events: none; }
        .toggle-container { display: flex; gap: 10px; margin-bottom: 15px; }
        .toggle-btn { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; text-align: center; cursor: pointer; background: white; transition: 0.2s; }
        .toggle-btn.active { background: var(--accent) !important; color: white !important; }
        .expand-panel { display: none; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-top: 10px; }
        .pl-table { width: 100%; font-size: 0.85rem; border-collapse: collapse; }
        .pl-table tr { border-bottom: 1px solid #eee; }
        .pl-table td { padding: 12px 5px; }
        .pl-label { color: #666; }
        .pl-val { text-align: right; font-weight: bold; }
        .pl-total { background: #f8f9fa; font-weight: bold; border-top: 2px solid var(--text); }
        .pl-detail-box { font-size: 0.75rem; color: #7f8c8d; background: #fdfdfd; padding: 8px; border-radius: 4px; margin-top: 4px; line-height: 1.4; border-left: 3px solid #ddd; }
        table.result-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .result-table th, .result-table td { border-bottom: 1px solid #eee; padding: 8px; text-align: right; }
        .selected-row { background-color: #e3f2fd !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 style="text-align:center; font-size:1.1rem;">äººç”Ÿã‚µãƒã‚¤ãƒãƒ«</h2>
    <button class="tab-btn active" onclick="openTab(event, 'basic')">ğŸ  åŸºæœ¬è¨­å®š</button>
    <div class="sub-tab-container">
        <button class="tab-btn sub-tab" onclick="openTab(event, 'detailIncome')">â”œ åå…¥è¨­å®š</button>
        <button class="tab-btn sub-tab" onclick="openTab(event, 'detailLiving')">â”œ å­¦è²»ãƒ»ç”Ÿæ´»è²»</button>
        <button class="tab-btn sub-tab" onclick="openTab(event, 'detailCar')">â”œ è‡ªå‹•è»Šè¨­å®š</button>
        <button class="tab-btn sub-tab" onclick="openTab(event, 'detailInvest')">â”” æŠ•è³‡ãƒ»å‡ºå£æˆ¦ç•¥</button>
    </div>
    <div style="margin-top: auto; padding: 20px;">
        <button onclick="simulate()" style="width:100%; padding:15px; background:var(--accent); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold;">è¨ˆç®—å®Ÿè¡Œ</button>
    </div>
</div>

<div class="main-content">
    <div class="config-area">
        <div id="basic" class="tab-content active">
            <h1>åŸºæœ¬è¨­å®š</h1>
            <div class="card">
                <div class="section-title">å¿…é ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                <div style="display:flex; gap:15px; margin-bottom:15px;">
                    <div style="flex:1;"><label>ç¾åœ¨ã®å¹´é½¢</label><input type="number" id="baseAge" value="25" oninput="refreshIncomeGrid()"></div>
                    <div style="flex:1;"><label>åˆæœŸç¾é‡‘</label><div class="unit-input unit-man"><input type="number" id="baseInitialCash" value="100"></div></div>
                </div>

                <div class="section-title">åå…¥ã®è¨­å®š</div>
                <label><input type="radio" name="incomeModeBasic" value="fixed" checked onclick="syncIncomeMode('fixed')"> ä¸€æ‹¬è¨­å®šï¼ˆå¹³å‡å¹´åï¼‰</label>
                <div class="unit-input unit-man" id="basicSalaryContainer">
                    <input type="number" id="baseSalaryBasic" value="450">
                </div>
                <label style="margin-top:10px; display:inline-block;"><input type="radio" name="incomeModeBasic" value="variable" onclick="syncIncomeMode('variable')"> å€‹åˆ¥è¨­å®šï¼ˆå¹´é½¢åˆ¥ï¼‰</label>
                <div id="basicVariableGuide" style="display:none; font-size:0.8rem; color:var(--accent); padding:5px;">ğŸ‘‰ ã€Œåå…¥è¨­å®šã€ã‚¿ãƒ–ã§è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>

                <div class="section-title">ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«</div>
                <label>çµå©šã®äºˆå®š</label>
                <div class="toggle-container">
                    <div id="mOff" class="toggle-btn active" onclick="setToggle('married', false)">ã—ãªã„</div>
                    <div id="mOn" class="toggle-btn" onclick="setToggle('married', true)">ã™ã‚‹</div>
                </div>
                <div id="basicMarriedExpand" class="expand-panel">
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div style="flex:1;"><label>çµå©šå¹´é½¢</label><input type="number" id="mAge" value="30"></div>
                        <div style="flex:1;"><label>å­ä¾›ã®æ•°</label><select id="childCount" onchange="updateChildUI()"></select></div>
                    </div>
                    <div id="childRaisingPanel" style="display:none;">
                        <label>å­ä¾›1äººã‚ãŸã‚Šã®é¤Šè‚²è²»/æœˆ</label>
                        <div class="unit-input unit-man"><input type="number" id="childRaisingCost" value="6"></div>
                    </div>
                </div>

                <label>è³‡ç”£é‹ç”¨ã®äºˆå®š</label>
                <div class="toggle-container">
                    <div id="iOff" class="toggle-btn active" onclick="setToggle('invest', false)">ã—ãªã„</div>
                    <div id="iOn" class="toggle-btn" onclick="setToggle('invest', true)">ã™ã‚‹</div>
                </div>
                <div id="basicInvestExpand" class="expand-panel">
                    <label>æ¯æœˆã®ç©ç«‹é¡</label>
                    <div class="unit-input unit-man"><input type="number" id="baseInvest" value="5"></div>
                </div>
            </div>
        </div>

        <div id="detailIncome" class="tab-content">
            <h1>è©³ç´°è¨­å®šï¼šåå…¥</h1>
            <div class="card">
                <p id="detailIncomeAlert" style="color:var(--danger); font-size:0.8rem;">â€»ç¾åœ¨ã¯ã€Œä¸€æ‹¬è¨­å®šã€ãƒ¢ãƒ¼ãƒ‰ã§ã™</p>
                <div class="section-title">å¹´é½¢åˆ¥å¹´åè¨­å®š</div>
                <div id="salaryGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap:10px;"></div>
                <div class="section-title">å®šå¹´</div>
                <label>å®šå¹´å¹´é½¢</label><input type="number" id="retireAge" value="65" oninput="refreshIncomeGrid()" style="width:80px; padding:8px;">
            </div>
        </div>

        <div id="detailLiving" class="tab-content">
            <h1>è©³ç´°è¨­å®šï¼šå­¦è²»ãƒ»ç”Ÿæ´»è²»</h1>
            <div class="card">
                <label>ç‹¬èº«æ™‚ ç”Ÿæ´»è²»/æœˆ</label><div class="unit-input unit-man"><input type="number" id="baseLiving" value="20"></div>
                <label>çµå©šå¾Œ ç”Ÿæ´»è²»/æœˆ</label><div class="unit-input unit-man"><input type="number" id="marriedLiving" value="30"></div>
                <div id="childSettingsContainer"></div>
            </div>
        </div>

        <div id="detailCar" class="tab-content"><h1>è©³ç´°è¨­å®šï¼šè‡ªå‹•è»Š</h1><div class="card"><div class="toggle-container"><div id="carOff" class="toggle-btn active" onclick="setCarToggle(false)">ãªã—</div><div id="carOn" class="toggle-btn" onclick="setCarToggle(true)">ã‚ã‚Š</div></div><div id="carExpand" style="display:none;"><label>è³¼å…¥å¹´é½¢</label><input type="number" id="carAge" value="30"><label>ä¾¡æ ¼</label><div class="unit-input unit-man"><input type="number" id="carPrice" value="300"></div><label>ç¶­æŒè²»/å¹´</label><div class="unit-input unit-man"><input type="number" id="carMaintenance" value="35"></div></div></div></div>

        <div id="detailInvest" class="tab-content">
            <h1>è©³ç´°è¨­å®šï¼šæŠ•è³‡</h1>
            <div id="investMask" class="card disabled-field">
                <label>å¹´åˆ©å›ã‚Š</label><div class="unit-input unit-percent"><input type="number" id="baseRate" value="5"></div>
                <label>å–å´©é–‹å§‹å¹´é½¢</label><input type="number" id="startWithdrawAge" value="65" style="width:80px; padding:8px;">
                <label>å–å´©ç‡</label><div class="unit-input unit-percent"><input type="number" id="withdrawRate" value="4"></div>
            </div>
        </div>

        <div id="resultArea" style="display:none;">
            <div id="statusMessage"></div>
            <div class="card"><canvas id="assetChart" style="max-height: 250px;"></canvas></div>
            <div class="card"><table class="result-table"><thead><tr><th>å¹´é½¢</th><th>ç¾é‡‘</th><th>æŠ•è³‡</th><th>å­¦è²»(å¹´)</th><th>åˆè¨ˆ</th></tr></thead><tbody id="tableBody"></tbody></table></div>
        </div>
    </div>

    <div class="analysis-area" id="analysisArea" style="display:none;">
        <div class="card" style="position: sticky; top: 20px;">
            <h3 style="text-align:center; margin-top:0;">æç›Šè¨ˆç®—æ›¸ (P/L) <span id="pl-age-label" style="font-size:0.9rem; color:var(--accent);"></span></h3>
            <table class="pl-table">
                <tr><td class="pl-label">çµ¦ä¸æ‰‹å–ã‚Š (æœˆ)</td><td class="pl-val" id="pl-salary">0ä¸‡</td></tr>
                <tr class="pl-total"><td>ç·åå…¥</td><td class="pl-val" id="pl-total-income">0ä¸‡</td></tr>
                <tr><td class="pl-label">åŸºæœ¬ç”Ÿæ´»è²»</td><td class="pl-val" id="pl-living">0ä¸‡</td></tr>
                <tr><td class="pl-label">å­¦è²» (æœˆæŒ‰åˆ†)</td><td class="pl-val" id="pl-edu">0ä¸‡</td></tr>
                <tr><td colspan="2"><div id="pl-edu-detail" class="pl-detail-box">ãªã—</div></td></tr>
                <tr><td class="pl-label">é¤Šè‚²è²» (æœˆé¡)</td><td class="pl-val" id="pl-raising">0ä¸‡</td></tr>
                <tr><td colspan="2"><div id="pl-raising-detail" class="pl-detail-box">å¯¾è±¡ãªã—</div></td></tr>
                <tr class="pl-total"><td>æœˆé–“åæ”¯</td><td class="pl-val" id="pl-net">0ä¸‡</td></tr>
            </table>
        </div>
    </div>
</div>

<script>
let charts = {};
let config = { isMarried: false, isInvest: false, incomeMode: 'fixed' };

function init() {
    const s = document.getElementById('childCount');
    for(let i=0; i<=5; i++) s.innerHTML += `<option value="${i}">${i}äºº</option>`;
    const grid = document.getElementById('salaryGrid');
    for(let a=20; a<=70; a+=5) {
        grid.innerHTML += `<div class="grid-item" id="salary-group-${a}">${a}æ­³ã€œ<div class="unit-input unit-man"><input type="number" class="s-input" data-age="${a}" value="450"></div></div>`;
    }
    refreshIncomeGrid();
}

function syncIncomeMode(mode) {
    config.incomeMode = mode;
    document.getElementById('basicSalaryContainer').style.display = (mode === 'fixed') ? 'block' : 'none';
    document.getElementById('basicVariableGuide').style.display = (mode === 'variable') ? 'block' : 'none';
    document.getElementById('detailIncomeAlert').style.display = (mode === 'fixed') ? 'block' : 'none';
    refreshIncomeGrid();
}

function refreshIncomeGrid() {
    const currentAge = parseInt(document.getElementById('baseAge').value) || 0;
    const retireAge = parseInt(document.getElementById('retireAge').value) || 0;

    document.querySelectorAll('.s-input').forEach(input => {
        const a = parseInt(input.dataset.age);
        const group = document.getElementById(`salary-group-${a}`);
        // 1. ä¸€æ‹¬ãƒ¢ãƒ¼ãƒ‰ 2. ç¾åœ¨ã‚ˆã‚Šå‰ 3. å®šå¹´ã‚ˆã‚Šå¾Œ ã‚’ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
        const isDisabled = (config.incomeMode === 'fixed' || a < currentAge || a >= retireAge);
        input.disabled = isDisabled;
        group.classList.toggle('disabled-field', isDisabled);
    });
}

function setToggle(type, val) {
    config[type === 'married' ? 'isMarried' : 'isInvest'] = val;
    if(type==='married') document.getElementById('basicMarriedExpand').style.display = val ? 'block' : 'none';
    if(type==='invest') {
        document.getElementById('basicInvestExpand').style.display = val ? 'block' : 'none';
        document.getElementById('investMask').classList.toggle('disabled-field', !val);
    }
    const prefix = (type==='married') ? 'm' : 'i';
    document.getElementById(prefix+(val?'On':'Off')).classList.add('active');
    document.getElementById(prefix+(val?'Off':'On')).classList.remove('active');
}

function openTab(evt, tabId) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    if(evt) evt.currentTarget.classList.add('active');
}

function updateChildUI() {
    const count = document.getElementById('childCount').value;
    document.getElementById('childRaisingPanel').style.display = count > 0 ? 'block' : 'none';
    renderChildSettings();
}

function renderChildSettings() {
    const count = document.getElementById('childCount').value;
    const container = document.getElementById('childSettingsContainer');
    container.innerHTML = count > 0 ? '<div class="section-title">å­ä¾›ã”ã¨ã®å€‹åˆ¥å­¦è²»è¨­å®š</div>' : '';
    for(let i=1; i<=count; i++) {
        container.innerHTML += `<div class="card"><strong>ç¬¬${i}å­</strong> èª•ç”Ÿæ™‚è¦ªå¹´é½¢: <input type="number" class="c-birth" value="${30+i*2}" style="width:50px;">
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; margin-top:5px; font-size:0.7rem;">
                <div>å¹¼<input type="number" class="c-k" value="40"></div><div>å°<input type="number" class="c-s" value="45"></div><div>ä¸­<input type="number" class="c-j" value="50"></div>
                <div>é«˜<input type="number" class="c-h" value="55"></div><div>å¤§<input type="number" class="c-d" value="150"></div>
            </div></div>`;
    }
}

function simulate() {
    const startAge = parseInt(document.getElementById('baseAge').value);
    const retireAge = parseInt(document.getElementById('retireAge').value);
    const raisingCostPerM = parseFloat(document.getElementById('childRaisingCost').value) || 0;
    const investM = config.isInvest ? parseFloat(document.getElementById('baseInvest').value) : 0;
    const rate = config.isInvest ? parseFloat(document.getElementById('baseRate').value)/100 : 0;

    let cash = parseFloat(document.getElementById('baseInitialCash').value);
    let investment = 0;
    const yearlyData = [];
    let deadAge = null;

    const sMap = {}; document.querySelectorAll('.s-input').forEach(i => sMap[i.dataset.age] = parseFloat(i.value));
    const children = Array.from(document.querySelectorAll('.c-birth')).map((input, idx) => ({
        birth: parseInt(input.value),
        k: parseFloat(document.querySelectorAll('.c-k')[idx].value), s: parseFloat(document.querySelectorAll('.c-s')[idx].value),
        j: parseFloat(document.querySelectorAll('.c-j')[idx].value), h: parseFloat(document.querySelectorAll('.c-h')[idx].value),
        d: parseFloat(document.querySelectorAll('.c-d')[idx].value)
    }));

    for(let a = startAge; a <= 100; a++) {
        let annualSal = 0;
        if(a < retireAge) {
            if(config.incomeMode === 'fixed') annualSal = parseFloat(document.getElementById('baseSalaryBasic').value);
            else { annualSal = 450; Object.keys(sMap).sort((x,y)=>x-y).forEach(k => { if(a >= k) annualSal = sMap[k]; }); }
        }
        let salM = (annualSal * 0.8) / 12;
        let livM = (config.isMarried && a >= document.getElementById('mAge').value) ? parseFloat(document.getElementById('marriedLiving').value) : parseFloat(document.getElementById('baseLiving').value);

        let eduY = 0; let raisingCount = 0; let eduDetails = [];
        children.forEach((c, idx) => {
            let cage = a - c.birth;
            let cost = 0; let label = "";
            if(cage >= 3 && cage < 6) { cost = c.k; label = "å¹¼ç¨šåœ’"; }
            else if(cage >= 6 && cage < 12) { cost = c.s; label = "å°å­¦æ ¡"; }
            else if(cage >= 12 && cage < 15) { cost = c.j; label = "ä¸­å­¦æ ¡"; }
            else if(cage >= 15 && cage < 18) { cost = c.h; label = "é«˜æ ¡"; }
            else if(cage >= 18 && cage < 22) { cost = c.d; label = "å¤§å­¦"; }
            if(cost > 0) { eduY += cost; eduDetails.push(`ç¬¬${idx+1}å­ï¼š${label}`); }
            if(cage >= 0 && cage <= 22) raisingCount++;
        });

        // æŠ•è³‡è¨ˆç®—
        let withY = (config.isInvest && a >= document.getElementById('startWithdrawAge').value) ? investment * (parseFloat(document.getElementById('withdrawRate').value)/100) : 0;
        let netM = (salM + withY/12) - (livM + (eduY/12) + (raisingCount * raisingCostPerM) + investM);

        cash += netM * 12;
        if(config.isInvest) investment = (investment * (1 + rate)) + (investM * 12) - withY;
        if(investment < 0) investment = 0;
        if(cash < 0 && !deadAge) deadAge = a;

        const dp = { age: a, cash, investment, salM, withY, livM, eduY, eduDetails, raisingCount, raisingCostPerM, balance: netM };
        yearlyData.push(dp);
        if(a === startAge) updatePL(dp);
    }

    document.getElementById('resultArea').style.display = 'block';
    document.getElementById('analysisArea').style.display = 'block';
    document.getElementById('statusMessage').innerHTML = deadAge ? `<h2 style="color:var(--danger)">âš ï¸ ${deadAge}æ­³ã§æ¯æ¸‡</h2>` : `<h2 style="color:var(--success)">âœ… 100æ­³ã¾ã§å®‰æ³°</h2>`;
    updateCharts(yearlyData);
    document.getElementById('tableBody').innerHTML = yearlyData.map(d => `<tr onclick='updatePL(${JSON.stringify(d)})'><td>${d.age}æ­³</td><td>${Math.round(d.cash)}ä¸‡</td><td>${Math.round(d.investment)}ä¸‡</td><td>${d.eduY}ä¸‡</td><td>${Math.round(d.cash+d.investment)}ä¸‡</td></tr>`).join('');
}

function updatePL(d) {
    document.getElementById('pl-age-label').innerText = `(${d.age}æ­³æ™‚)`;
    document.getElementById('pl-salary').innerText = Math.round(d.salM + d.withY/12) + "ä¸‡";
    document.getElementById('pl-total-income').innerText = Math.round(d.salM + d.withY/12) + "ä¸‡";
    document.getElementById('pl-living').innerText = "-" + d.livM + "ä¸‡";
    document.getElementById('pl-edu').innerText = "-" + Math.round(d.eduY/12) + "ä¸‡";
    document.getElementById('pl-edu-detail').innerHTML = d.eduDetails.length ? d.eduDetails.join('<br>') : "ãªã—";
    document.getElementById('pl-raising').innerText = "-" + (d.raisingCount * d.raisingCostPerM) + "ä¸‡";
    document.getElementById('pl-raising-detail').innerText = d.raisingCount > 0 ? `${d.raisingCount}äººåˆ† (1äºº${d.raisingCostPerM}ä¸‡/æœˆ)` : "å¯¾è±¡ãªã—";
    const net = Math.round(d.balance);
    document.getElementById('pl-net').innerText = (net > 0 ? "+" : "") + net + "ä¸‡";
    document.getElementById('pl-net').style.color = net >= 0 ? "var(--success)" : "var(--danger)";
}

function updateCharts(data) {
    if(charts.main) charts.main.destroy();
    charts.main = new Chart(document.getElementById('assetChart'), {
        type: 'line',
        data: { labels: data.map(d=>d.age), datasets: [{ label: 'ç·è³‡ç”£', data: data.map(d=>Math.round(d.cash+d.investment)), borderColor: '#3498db', fill: true }] }
    });
}
function setCarToggle(v) { document.getElementById('carExpand').style.display = v ? 'block' : 'none'; }
init();
</script>
</body>
</html>
