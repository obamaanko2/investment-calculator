<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>äººç”Ÿè¨­è¨ˆã‚µãƒã‚¤ãƒãƒ« | å®Œå…¨ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --sidebar-width: 250px;
            --main-bg: #f8f9fa;
            --accent: #3498db;
            --text: #2c3e50;
            --danger: #e74c3c;
            --success: #2ecc71;
        }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; color: var(--text); }
        .sidebar { width: var(--sidebar-width); background: var(--text); color: white; display: flex; flex-direction: column; padding-top: 20px; flex-shrink: 0; }
        .tab-btn { background: none; border: none; color: #adb5bd; padding: 15px 20px; text-align: left; cursor: pointer; border-left: 4px solid transparent; transition: 0.3s; }
        .tab-btn.active { background: #34495e; color: white; border-left: 4px solid var(--accent); }

        .main-content { flex: 1; background: var(--main-bg); overflow-y: auto; padding: 30px; display: grid; grid-template-columns: 1fr 380px; gap: 25px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }

        .unit-input { position: relative; display: flex; align-items: center; margin-bottom: 5px; }
        .unit-input input, .unit-input select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; background: white; }
        /* ä¸‡å††å˜ä½ã®ç–‘ä¼¼è¦ç´  */
        .unit-man::after { content: "ä¸‡å††"; position: absolute; right: 10px; font-size: 0.8rem; color: #888; }
        .unit-percent::after { content: "%"; position: absolute; right: 10px; font-size: 0.8rem; color: #888; }

        .net-hint { font-size: 0.8rem; color: var(--accent); font-weight: bold; margin-bottom: 15px; display: block; }
        .section-title { font-size: 0.9rem; font-weight: bold; margin: 15px 0 10px 0; color: var(--accent); border-left: 3px solid var(--accent); padding-left: 8px; }

        .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; }
        .grid-item { display: flex; flex-direction: column; gap: 5px; background: #fdfdfd; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .grid-item label { font-size: 0.75rem; color: #666; font-weight: bold; }
        .grid-item input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }

        #childAgesContainer { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .child-age-box { display: flex; flex-direction: column; width: 85px; }
        .child-age-box label { font-size: 0.7rem; color: #666; margin-bottom: 2px; }

        .status-banner { padding: 15px; border-radius: 10px; text-align: center; font-weight: bold; margin-bottom: 20px; border: 1px solid; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; cursor: pointer; }
        th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: right; }
        .selected-row { background-color: #e3f2fd !important; font-weight: bold; }

        .deficit-text { color: var(--danger); font-weight: bold; }
        .surplus-text { color: var(--success); font-weight: bold; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 style="text-align:center; font-size:1.2rem;">äººç”Ÿã‚µãƒã‚¤ãƒãƒ«</h2>
    <button class="tab-btn active" onclick="openTab(event, 'basic')">ğŸ  åŸºæœ¬è¨­å®š</button>
    <button class="tab-btn" onclick="openTab(event, 'incomeDetail')">ğŸ’° åå…¥è©³ç´°</button>
    <button class="tab-btn" onclick="openTab(event, 'investDetail')">ğŸ“ˆ æŠ•è³‡è©³ç´°</button>
    <div style="margin-top: auto; padding: 20px;">
        <button onclick="simulate()" style="width:100%; padding:15px; background:var(--accent); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold;">è¨ˆç®—å®Ÿè¡Œ</button>
    </div>
</div>

<div class="main-content">
    <div class="config-area">
        <div id="basic" class="tab-content active">
            <h1>åŸºæœ¬è¨­å®š</h1>
            <div class="card">
                <div class="section-title">åå…¥ãƒ»å®šå¹´</div>
                <div style="display:flex; gap:15px;">
                    <div style="flex:1;"><label>ç¾åœ¨ã®å¹´é½¢</label><input type="number" id="baseAge" value="25" style="width:100%; padding:10px; border-radius:6px; border:1px solid #ddd;"></div>
                    <div style="flex:1;"><label>å®šå¹´(çµ¦ä¸çµ‚äº†)</label><input type="number" id="retireAge" value="65" style="width:100%; padding:10px; border-radius:6px; border:1px solid #ddd;"></div>
                </div>
                <label style="margin-top:10px; display:block;">åŸºæœ¬å¹´å (ãƒœãƒ¼ãƒŠã‚¹æŠœã/é¡é¢)</label>
                <div class="unit-input unit-man"><input type="number" id="baseSalary" value="450" oninput="updateNetDisplay()"></div>
                <span id="netDisplay" class="net-hint">æ¨å®šæœˆã®æ‰‹å–ã‚Š: 30ä¸‡å††</span>
                <label>åˆæœŸç¾é‡‘</label><div class="unit-input unit-man"><input type="number" id="baseInitialCash" value="100"></div>

                <div class="section-title">æ”¯å‡ºãƒ»æŠ•è³‡ãƒ»å–ã‚Šå´©ã—</div>
                <div style="display:flex; gap:15px;">
                    <div style="flex:1;"><label>ç‹¬èº«æ™‚ç”Ÿæ´»è²»(æœˆ)</label><div class="unit-input unit-man"><input type="number" id="baseLiving" value="20"></div></div>
                    <div style="flex:1;"><label>çµå©šå¾Œç”Ÿæ´»è²»(æœˆ)</label><div class="unit-input unit-man"><input type="number" id="marriedLiving" value="30"></div></div>
                </div>
                <div style="display:flex; gap:15px; margin-top:10px;">
                    <div style="flex:2;"><label>æœˆé–“æŠ•è³‡é¡</label><div class="unit-input unit-man"><input type="number" id="baseInvest" value="5"></div></div>
                    <div style="flex:1;"><label>å¹´åˆ©(%)</label><div class="unit-input unit-percent"><input type="number" id="baseRate" value="5"></div></div>
                </div>
                <div style="display:flex; gap:15px; margin-top:10px;">
                    <div style="flex:1;"><label>æŠ•è³‡çµ‚äº†(å¹´é½¢)</label><input type="number" id="investEndAge" value="65" style="width:100%; padding:10px; border-radius:6px; border:1px solid #ddd;"></div>
                    <div style="flex:1;"><label>å–ã‚Šå´©ã—å‰²åˆ(å¹´)</label><div class="unit-input unit-percent"><input type="number" id="withdrawRate" value="4"></div></div>
                </div>

                <div class="section-title">ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆ</div>
                <label>çµå©šå¹´é½¢</label>
                <input type="number" id="mAge" value="28" style="width:100px; padding:10px; border-radius:6px; border:1px solid #ddd; margin-bottom:15px; display:block;">

                <label>å­ä¾›ã®æ•°</label>
                <div class="unit-input" style="width:100px;">
                    <select id="childCount" onchange="toggleChildInputs()">
                        <option value="0">0äºº</option>
                        <option value="1">1äºº</option>
                        <option value="2" selected>2äºº</option>
                        <option value="3">3äºº</option>
                    </select>
                </div>
                <div id="childAgesContainer"></div>
                <div style="margin-top:15px;">
                    <label>å­ä¾›1äººå½“ã‚Šæ•™è‚²è²»(æœˆé¡)</label>
                    <div class="unit-input unit-man"><input type="number" id="cCost" value="6"></div>
                </div>
            </div>
        </div>

        <div id="incomeDetail" class="tab-content">
            <h1>å¹´é½¢åˆ¥ å¹´åè¨­å®š (é¡é¢)</h1>
            <p style="font-size:0.8rem; color:#666;">â€»å…¥åŠ›ã—ãŸå¹´é½¢ä»¥é™ã®å¹´åãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ç©ºæ¬„ã¯åŸºæœ¬å¹´åã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</p>
            <div class="card"><div id="salaryGrid" class="grid-layout"></div></div>
        </div>

        <div id="investDetail" class="tab-content">
            <h1>å¹´é½¢åˆ¥ æœˆé–“æŠ•è³‡é¡</h1>
            <p style="font-size:0.8rem; color:#666;">â€»å…¥åŠ›ã—ãŸå¹´é½¢ä»¥é™ã®ç©ç«‹é¡ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ç©ºæ¬„ã¯åŸºæœ¬æŠ•è³‡é¡ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</p>
            <div class="card"><div id="investGrid" class="grid-layout"></div></div>
        </div>

        <div id="resultArea" style="display:none;">
            <div id="statusMessage"></div>
            <div class="card"><canvas id="assetChart" style="max-height: 250px;"></canvas></div>
            <div class="card"><div style="max-height: 300px; overflow-y: auto;"><table><thead><tr><th>å¹´é½¢</th><th>ç¾é‡‘</th><th>æŠ•è³‡è©•ä¾¡</th><th>è³‡ç”£åˆè¨ˆ</th></tr></thead><tbody id="tableBody"></tbody></table></div></div>
        </div>
    </div>

    <div class="analysis-area" id="analysisArea" style="display:none;">
        <div class="card">
            <h3 id="analysisTitle" style="text-align:center; margin-top:0;">è©³ç´°åˆ†æ</h3>
            <div style="margin-bottom:25px;">
                <p style="font-size:0.8rem; font-weight:bold; color:#666; text-align:center;">æœˆé–“åæ”¯å†…è¨³</p>
                <canvas id="budgetChart"></canvas>
                <div id="budgetDetailText" style="margin-top:15px; font-size:0.85rem; line-height:1.6; border-top:1px solid #eee; padding-top:10px;"></div>
            </div>
            <hr>
            <div style="margin-top:20px;">
                <p style="font-size:0.8rem; font-weight:bold; color:#666; text-align:center;">ä¿æœ‰è³‡ç”£ãƒãƒ©ãƒ³ã‚¹</p>
                <canvas id="balanceChart"></canvas>
                <div id="assetDetailText" style="margin-top:15px; font-size:0.85rem; line-height:1.6; border-top:1px solid #eee; padding-top:10px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
let charts = {};
let yearlyData = [];

function openTab(evt, name) {
    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.getElementById(name).classList.add("active");
    evt.currentTarget.classList.add("active");
}

function updateNetDisplay() {
    const salary = parseFloat(document.getElementById('baseSalary').value) || 0;
    const net = Math.round((salary * 0.8) / 12);
    document.getElementById('netDisplay').innerText = `æ¨å®šæœˆã®æ‰‹å–ã‚Š: ${net}ä¸‡å††`;
}

function toggleChildInputs() {
    const count = parseInt(document.getElementById('childCount').value);
    const container = document.getElementById('childAgesContainer');
    container.innerHTML = '';
    const defaults = [30, 33, 36, 39];
    for (let i = 1; i <= count; i++) {
        const div = document.createElement('div');
        div.className = 'child-age-box';
        div.innerHTML = `<label>ç¬¬${i}å­(æ­³)</label><input type="number" class="child-age-input" value="${defaults[i-1]}" style="padding:8px; border:1px solid #ddd; border-radius:4px;">`;
        container.appendChild(div);
    }
}

function initGrids() {
    const sGrid = document.getElementById('salaryGrid');
    const iGrid = document.getElementById('investGrid');
    sGrid.innerHTML = ''; iGrid.innerHTML = '';
    // 20æ­³ã‹ã‚‰70æ­³ã¾ã§5æ­³åˆ»ã¿ã§ä½œæˆ
    for(let a=20; a<=70; a+=5) {
        sGrid.innerHTML += `<div class="grid-item"><label>${a}æ­³ã€œ å¹´å</label><div class="unit-input unit-man"><input type="number" class="s-input" data-age="${a}"></div></div>`;
        iGrid.innerHTML += `<div class="grid-item"><label>${a}æ­³ã€œ æŠ•è³‡</label><div class="unit-input unit-man"><input type="number" class="i-input" data-age="${a}"></div></div>`;
    }
}

// åˆæœŸåŒ–
updateNetDisplay();
toggleChildInputs();
initGrids();

function simulate() {
    const startAge = parseInt(document.getElementById('baseAge').value);
    const retireAge = parseInt(document.getElementById('retireAge').value);
    const investEndAge = parseInt(document.getElementById('investEndAge').value);
    const withdrawRate = parseFloat(document.getElementById('withdrawRate').value) / 100;
    const rate = parseFloat(document.getElementById('baseRate').value) / 100;

    let cash = parseFloat(document.getElementById('baseInitialCash').value) * 10000;
    let investment = 0;

    const singleLiving = parseFloat(document.getElementById('baseLiving').value) * 10000;
    const marriedLiving = parseFloat(document.getElementById('marriedLiving').value) * 10000;
    const mAge = parseInt(document.getElementById('mAge').value);
    const cCost = parseFloat(document.getElementById('cCost').value) * 10000;
    const childAges = Array.from(document.querySelectorAll('.child-age-input')).map(input => parseInt(input.value));

    // è©³ç´°è¨­å®šã®ãƒãƒƒãƒ—åŒ– (å…¥åŠ›ãŒã‚ã‚‹æœ€æ–°ã®å¹´é½¢ã‚’é©ç”¨ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ç”¨)
    const sMap = {}; document.querySelectorAll('.s-input').forEach(i => { if(i.value) sMap[i.dataset.age] = i.value * 10000; });
    const iMap = {}; document.querySelectorAll('.i-input').forEach(i => { if(i.value) iMap[i.dataset.age] = i.value * 10000; });

    yearlyData = [];
    let deadAge = null;
    const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';

    // å‹•çš„ãªå¹´åãƒ»æŠ•è³‡é¡ã®å–å¾—é–¢æ•°
    const getValFromMap = (age, map, defaultVal) => {
        let activeAge = 0;
        Object.keys(map).forEach(key => { if(age >= key) activeAge = Math.max(activeAge, key); });
        return activeAge > 0 ? map[activeAge] : defaultVal;
    };

    for(let a = startAge; a <= 80; a++) {
        // å¹´åã¨æŠ•è³‡é¡ã®æ±ºå®š
        let currentSalary = (a >= retireAge) ? 0 : getValFromMap(a, sMap, document.getElementById('baseSalary').value * 10000);
        let currentMInvest = (a >= investEndAge) ? 0 : getValFromMap(a, iMap, document.getElementById('baseInvest').value * 10000);

        // å–ã‚Šå´©ã—
        let annualWithdraw = 0;
        if (a >= investEndAge && investment > 0) {
            annualWithdraw = investment * withdrawRate;
            investment -= annualWithdraw;
            cash += annualWithdraw;
        }

        let currentLiving = (a >= mAge) ? marriedLiving : singleLiving;
        let activeChildCount = childAges.filter(birthAge => a >= birthAge && a < birthAge + 23).length;
        let totalChildCost = activeChildCount * cCost;

        let netMonth = (currentSalary * 0.8) / 12;
        let outMonth = currentLiving + totalChildCost + currentMInvest;

        cash += (netMonth * 12 - outMonth * 12);
        investment = (investment * (1 + rate)) + (currentMInvest * 12);

        if (cash < 0 && deadAge === null) deadAge = a;

        let d = {
            age: a, cash: Math.max(cash, 0), investment, netMonth,
            living: currentLiving, invest: currentMInvest, child: totalChildCost,
            withdraw: annualWithdraw / 12, isRetired: a >= retireAge, isWithdrawing: a >= investEndAge
        };
        yearlyData.push(d);

        const row = tbody.insertRow();
        row.onclick = () => showDetail(d, row);
        row.insertCell(0).innerText = a + "æ­³";
        row.insertCell(1).innerText = Math.round(cash/10000).toLocaleString() + "ä¸‡";
        row.insertCell(2).innerText = Math.round(investment/10000).toLocaleString() + "ä¸‡";
        row.insertCell(3).innerText = Math.round((cash+investment)/10000).toLocaleString() + "ä¸‡";
    }

    document.getElementById('statusMessage').innerHTML = deadAge ? `<div class="status-banner" style="color:var(--danger); border-color:var(--danger); background:#fff5f5;">ğŸ’€ ${deadAge}æ­³ã§è³‡é‡‘æ¯æ¸‡</div>` : `<div class="status-banner" style="color:var(--success); border-color:var(--success); background:#f0fff4;">âœ¨ 80æ­³ã¾ã§ç”Ÿå­˜å¯èƒ½</div>`;
    document.getElementById('resultArea').style.display = 'block';
    document.getElementById('analysisArea').style.display = 'block';
    updateMainChart();
    showDetail(yearlyData[0], tbody.rows[0]);
}

function showDetail(d, row) {
    document.querySelectorAll('tr').forEach(r => r.classList.remove('selected-row'));
    row.classList.add('selected-row');
    document.getElementById('analysisTitle').innerText = `${d.age}æ­³ã®è©³ç´°åˆ†æ`;

    let totalOut = d.living + d.invest + d.child;
    let surplus = (d.netMonth + d.withdraw) - totalOut;
    let isDeficit = surplus < 0;

    if(charts.b) charts.b.destroy();
    charts.b = new Chart(document.getElementById('budgetChart'), {
        type: 'doughnut',
        data: {
            labels: isDeficit ? ['ç”Ÿæ´»è²»', 'æŠ•è³‡', 'æ•™è‚²è²»', 'èµ¤å­—'] : ['ç”Ÿæ´»è²»', 'æŠ•è³‡', 'æ•™è‚²è²»', 'ä½™å‰°'],
            datasets: [{ data: [d.living, d.invest, d.child, Math.abs(surplus)], backgroundColor: isDeficit ? ['#3498db', '#8e44ad', '#e67e22', '#e74c3c'] : ['#3498db', '#8e44ad', '#e67e22', '#2ecc71'] }]
        }
    });

    document.getElementById('budgetDetailText').innerHTML = `
        <div style="display:flex; justify-content:space-between;"><span>æ‰‹å–ã‚Šæœˆå:</span><b>${Math.round(d.netMonth/10000)}ä¸‡å††</b></div>
        ${d.isWithdrawing ? `<div style="display:flex; justify-content:space-between; color:var(--accent);"><span>è³‡ç”£å–ã‚Šå´©ã—(æœˆ):</span><b>+${Math.round(d.withdraw/10000)}ä¸‡å††</b></div>` : ''}
        <div style="display:flex; justify-content:space-between;"><span>æ”¯å‡ºåˆè¨ˆ:</span><b>${Math.round(totalOut/10000)}ä¸‡å††</b></div>
        <div style="display:flex; justify-content:space-between;" class="${isDeficit ? 'deficit-text' : 'surplus-text'}">
            <span>${isDeficit ? 'æœˆé–“èµ¤å­—:' : 'æœˆé–“ä½™å‰°:'}</span>
            <b>${Math.round(Math.abs(surplus)/10000)}ä¸‡å††</b>
        </div>
    `;

    if(charts.al) charts.al.destroy();
    charts.al = new Chart(document.getElementById('balanceChart'), {
        type: 'pie',
        data: { labels: ['ç¾é‡‘æ®‹é«˜', 'æŠ•è³‡è©•ä¾¡é¡'], datasets: [{ data: [d.cash, d.investment], backgroundColor: ['#1abc9c', '#f1c40f'] }] }
    });
    document.getElementById('assetDetailText').innerHTML = `
        <div style="display:flex; justify-content:space-between;"><span>ç¾é‡‘:</span><b>${Math.round(d.cash/10000).toLocaleString()}ä¸‡å††</b></div>
        <div style="display:flex; justify-content:space-between;"><span>æŠ•è³‡è©•ä¾¡é¡:</span><b>${Math.round(d.investment/10000).toLocaleString()}ä¸‡å††</b></div>
    `;
}

function updateMainChart() {
    if(charts.main) charts.main.destroy();
    charts.main = new Chart(document.getElementById('assetChart'), {
        type: 'line',
        data: { labels: yearlyData.map(d=>d.age+"æ­³"), datasets: [{ label: 'ç·è³‡ç”£(ä¸‡å††)', data: yearlyData.map(d=>Math.round((d.cash+d.investment)/10000)), borderColor: '#3498db', fill: true, tension: 0.1 }] }
    });
}
</script>
</body>
</html>
