<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>タスク管理ツール Web版（修正版・単一HTML）</title>
  <style>
    :root{
      --bg:#fff;--fg:#1b1f24;--muted:#6b7280;--line:#e5e7eb;--primary:#2563eb;--danger:#ef4444;--ok:#16a34a;
      --chip-high:#fde2e2;--chip-mid:#fff1c7;--chip-low:#e0ecff;--chip-done:#d1fae5;
      --card:#f8fafc;--shadow:0 1px 3px rgba(0,0,0,.08),0 10px 15px -3px rgba(0,0,0,.05);
    }
    @media (prefers-color-scheme: dark){
      :root{--bg:#0b0e13;--fg:#e5e7eb;--muted:#9ca3af;--line:#1f2937;--primary:#3b82f6;--danger:#f87171;--ok:#22c55e;--card:#0f141b;--chip-high:#3b1f23;--chip-mid:#3b3120;--chip-low:#13223b;--chip-done:#113522}
      .calendar .day{border-color:#1f2937}
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    header{position:sticky;top:0;z-index:10;background:var(--bg);backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:0 0 6px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .toolbar .group{display:flex;gap:6px;flex-wrap:wrap}
    button,select,input[type="date"],input[type="text"],input[type="number"]{border:1px solid var(--line);background:var(--bg);color:var(--fg);padding:8px 10px;border-radius:10px}
    button{cursor:pointer;box-shadow:var(--shadow);border-color:transparent}
    button.primary{background:var(--primary);color:white}
    button.ghost{background:transparent;border:1px solid var(--line);box-shadow:none}
    button.danger{background:var(--danger);color:white}
    button.ok{background:var(--ok);color:white}
    button:disabled{opacity:.6;cursor:not-allowed}

    main{display:grid;grid-template-columns: 1.2fr .8fr;gap:16px;padding:16px}
    @media (max-width: 980px){main{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow)}
    .card .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
    .card .body{padding:12px 14px}

    form#taskForm{display:grid;grid-template-columns: repeat(2,1fr);gap:10px}
    form#taskForm label{font-size:12px;color:var(--muted)}
    form#taskForm .row{display:flex;flex-direction:column;gap:6px}
    form#taskForm .row.full{grid-column:1/-1}

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);text-align:left;padding:8px 6px;font-size:14px}
    th{font-size:12px;color:var(--muted);font-weight:600}
    tr:hover{background:rgba(0,0,0,.03)}

    .calendar{user-select:none}
    .calendar .grid{display:grid;grid-template-columns: repeat(7,1fr);gap:6px}
    .calendar .weekday{font-weight:700;font-size:12px;color:var(--muted);padding:4px}
    .calendar .day{border:1px solid var(--line);border-radius:10px;min-height:120px;padding:6px;display:flex;flex-direction:column;gap:6px}
    .calendar .date{display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:12px;color:var(--muted)}
    .calendar .today{outline:2px solid var(--primary);outline-offset:2px}
    .cell-body{display:flex;flex-direction:column;gap:4px;overflow:auto}
    .task-chip{padding:4px 8px;border-radius:10px;border:1px solid rgba(0,0,0,.06);font-size:12px;display:flex;gap:6px;align-items:center;cursor:grab;}
    .task-chip.dragging{opacity:.6}
    .task-chip .dot{width:8px;height:8px;border-radius:50%}
    .priority-高{background:var(--chip-high)}
    .priority-中{background:var(--chip-mid)}
    .priority-低{background:var(--chip-low)}
    .task-chip.done{opacity:.6; text-decoration: line-through}
    .chip-start{border-top-left-radius:16px;border-bottom-left-radius:16px}
    .chip-end{border-top-right-radius:16px;border-bottom-right-radius:16px}
    .overflow{font-size:11px;color:var(--muted)}

    .calendar .nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .calendar .nav .title{font-weight:700}

    dialog{border:none;border-radius:14px;background:var(--bg);color:var(--fg);box-shadow:var(--shadow);width:min(520px,92vw)}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
    .modal-body{padding:12px}
    .footer{display:flex;justify-content:flex-end;gap:8px;border-top:1px solid var(--line);padding:10px}
    .muted{color:var(--muted)} .right{margin-left:auto}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>タスク管理ツール Web版（修正版）</h1>
      <div class="toolbar">
        <div class="group">
          <button id="btnAdd" class="primary" type="button">＋ タスク追加</button>
          <button id="btnExport" class="ghost" type="button">エクスポート</button>
          <button id="btnImport" class="ghost" type="button">インポート</button>
          <button id="btnClear" class="danger" type="button">全削除</button>
        </div>
        <div class="group right">
          <input id="search" type="text" placeholder="検索（タスク名/メモ）" />
          <select id="fltStatus"><option value="">すべてのステータス</option><option>未処理</option><option>処理中</option><option>処理済み</option></select>
          <select id="fltPriority"><option value="">すべての優先度</option><option>高</option><option>中</option><option>低</option></select>
          <select id="fltCategory"><option value="">すべてのカテゴリ</option><option>仕事</option><option>プライベート</option><option>学習</option><option>その他</option></select>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card calendar" aria-label="カレンダー">
      <div class="head">
        <div class="nav">
          <button id="prevMonth" class="ghost" type="button">◀</button>
          <div class="title" id="calTitle"></div>
          <button id="nextMonth" class="ghost" type="button">▶</button>
          <button id="btnToday" class="ghost" type="button">今日</button>
          <label class="muted" style="margin-left:8px"><input type="checkbox" id="toggleWeekdays"> 平日のみ</label>
          <select id="monthPicker"></select>
          <select id="yearPicker"></select>
        </div>
        <div class="muted">期限日を終点として、所要日数ぶん帯表示</div>
      </div>
      <div class="body">
        <div class="grid" id="weekdayHeader"></div>
        <div class="grid" id="calendarGrid"></div>
      </div>
    </section>

    <section class="stack">
      <div class="card">
        <div class="head"><div>タスク一覧</div><div class="muted">クリックで編集 / ✅で完了</div></div>
        <div class="body">
          <table id="taskTable" aria-label="タスク一覧">
            <thead>
              <tr>
                <th>✅</th><th>タスク名</th><th>期限</th><th>優先度</th><th>所要</th><th>ステータス</th><th>カテゴリ</th><th>メモ</th><th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="head"><div>タスク登録 / 編集</div><div class="muted">*は必須</div></div>
        <div class="body">
          <form id="taskForm">
            <input type="hidden" id="taskId">
            <div class="row"><label>タスク名*</label><input required id="taskName" type="text" placeholder="タスク名"></div>
            <div class="row"><label>期限*</label><input required id="deadline" type="date"></div>
            <div class="row"><label>優先度</label>
              <select id="priority"><option>高</option><option selected>中</option><option>低</option></select>
            </div>
            <div class="row"><label>所要日数*</label><input required id="duration" type="number" min="1" value="1"></div>
            <div class="row"><label>ステータス</label>
              <select id="status"><option selected>未処理</option><option>処理中</option><option>処理済み</option></select>
            </div>
            <div class="row"><label>カテゴリ</label>
              <select id="category"><option>仕事</option><option>プライベート</option><option>学習</option><option selected>その他</option></select>
            </div>
            <div class="row full"><label>メモ</label><input id="notes" type="text" placeholder="補足やURLなど"></div>
            <div class="row full" style="display:flex;gap:8px;margin-top:6px">
              <button class="primary" type="submit">保存</button>
              <button class="ghost" type="button" id="resetForm">リセット</button>
            </div>
          </form>
        </div>
      </div>
    </section>
  </main>

  <dialog id="quickDialog">
    <div class="modal-header">
      <strong>クイック編集</strong>
      <button class="ghost" onclick="document.getElementById('quickDialog').close()" type="button">✕</button>
    </div>
    <div class="modal-body">
      <div class="row"><label>タスク名</label><input id="qName" type="text"></div>
      <div class="row" style="margin-top:8px;display:flex;gap:8px">
        <label>ステータス <select id="qStatus"><option>未処理</option><option>処理中</option><option>処理済み</option></select></label>
        <label>優先度 <select id="qPriority"><option>高</option><option selected>中</option><option>低</option></select></label>
      </div>
      <div class="row" style="margin-top:8px;display:flex;gap:8px">
        <label>期限 <input id="qDeadline" type="date"></label>
        <label>所要 <input id="qDuration" type="number" min="1" value="1"></label>
      </div>
      <div class="row" style="margin-top:8px"><label>メモ</label><input id="qNotes" type="text"></div>
    </div>
    <div class="footer">
      <button class="danger" id="qDelete" type="button">削除</button>
      <button class="primary" id="qSave" type="button">保存</button>
    </div>
  </dialog>

  <input type="file" id="filePicker" accept="application/json" hidden>

  <script>
    // ===== Utilities =====
    const storeKey = 'tasks.v3';              // ← ストレージ版数を更新
    let tasks = [];
    let currentMonth = new Date();

    const clamp   = (v,min,max)=> Math.max(min, Math.min(max,v));
    const fmtDate = (d)=> d? new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10) : '';
    const parseYmd= (str)=>{ if(!str) return null; const [y,m,d]=str.split('-').map(Number); return new Date(y, (m||1)-1, d||1); };
    const addDays = (date, n)=> { const x=new Date(date.getFullYear(), date.getMonth(), date.getDate()); x.setDate(x.getDate()+n); return x; };

    function load(){ try{ tasks = JSON.parse(localStorage.getItem(storeKey) || '[]') }catch{ tasks = [] } }
    function save(){ localStorage.setItem(storeKey, JSON.stringify(tasks)) }

    function upsert(task){
      const i = tasks.findIndex(t=>t.id===task.id);
      if(i>-1) tasks[i]=task; else tasks.push(task);
      save(); renderAll();
    }
    function removeById(id){ tasks = tasks.filter(t=>t.id!==id); save(); renderAll() }
    function uid(){ return Math.random().toString(36).slice(2,9)+Date.now().toString(36) }

    // ===== Filters =====
    function taskMatchesFilter(t){
      const q  = document.getElementById('search').value.trim().toLowerCase();
      const fs = document.getElementById('fltStatus').value;
      const fp = document.getElementById('fltPriority').value;
      const fc = document.getElementById('fltCategory').value;
      if(fs && t.status!==fs) return false;
      if(fp && t.priority!==fp) return false;
      if(fc && t.category!==fc) return false;
      if(q){ const hay = `${t.taskName} ${t.notes||''}`.toLowerCase(); if(!hay.includes(q)) return false }
      return true;
    }

    // ===== Form =====
    const form = document.getElementById('taskForm');
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = document.getElementById('taskId').value || uid();
      const task = {
        id,
        taskName: document.getElementById('taskName').value.trim(),
        deadline: document.getElementById('deadline').value,
        priority: document.getElementById('priority').value,
        duration: clamp(parseInt(document.getElementById('duration').value||'1',10),1,365),
        status: document.getElementById('status').value,
        category: document.getElementById('category').value,
        notes: document.getElementById('notes').value.trim(),
        updatedAt: Date.now(),
        createdAt: document.getElementById('taskId').value? undefined : Date.now()
      };
      if(!task.taskName || !task.deadline){ alert('タスク名と期限は必須です'); return }
      upsert(task);
      form.reset(); document.getElementById('taskId').value='';
    });
    document.getElementById('resetForm').addEventListener('click',()=>{ form.reset(); document.getElementById('taskId').value='' });

    function fillForm(task){
      document.getElementById('taskId').value = task.id;
      document.getElementById('taskName').value = task.taskName;
      document.getElementById('deadline').value = task.deadline;
      document.getElementById('priority').value = task.priority;
      document.getElementById('duration').value = task.duration;
      document.getElementById('status').value = task.status;
      document.getElementById('category').value = task.category;
      document.getElementById('notes').value = task.notes||'';
    }

    // ===== Table =====
    function renderTable(){
      const tbody = document.querySelector('#taskTable tbody');
      tbody.innerHTML='';
      const data = tasks.filter(taskMatchesFilter).sort((a,b)=> (a.deadline||'').localeCompare(b.deadline||''));
      for(const t of data){
        const done = t.status==='処理済み';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" ${done?'checked':''} data-id="${t.id}" class="chkDone"></td>
          <td class="name" title="クリックで編集">${t.taskName}</td>
          <td>${t.deadline||''}</td>
          <td>${t.priority||''}</td>
          <td>${t.duration||''}</td>
          <td>${t.status||''}</td>
          <td>${t.category||''}</td>
          <td>${t.notes||''}</td>
          <td>
            <button class="ghost" data-id="${t.id}" data-action="edit" type="button">編集</button>
            <button class="ghost danger" data-id="${t.id}" data-action="del" type="button">削除</button>
          </td>`;
        tbody.appendChild(tr);
      }
    }

    // ✅ イベント委譲（多重バインド防止）
    (function bindTableDelegates(){
      const tbody = document.querySelector('#taskTable tbody');
      tbody.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-action]');
        if(!btn) return;
        const id = btn.dataset.id;
        const t = tasks.find(x=>x.id===id);
        if(!t) return;
        if(btn.dataset.action==='edit'){ fillForm(t); window.scrollTo({top:0,behavior:'smooth'}); }
        if(btn.dataset.action==='del'){ if(confirm('削除しますか？')) removeById(id); }
      });
      tbody.addEventListener('change', (e)=>{
        const chk = e.target.closest('.chkDone');
        if(!chk) return;
        const id = chk.dataset.id;
        const idx = tasks.findIndex(x=>x.id===id);
        if(idx===-1) return;
        const newStatus = chk.checked ? '処理済み' : '未処理';
        tasks[idx] = {...tasks[idx], status:newStatus, updatedAt:Date.now()};
        save();
        renderAll();
      });
    })();

    // ===== Calendar =====
    const weekdayHeader = document.getElementById('weekdayHeader');
    const calendarGrid  = document.getElementById('calendarGrid');
    const monthPicker   = document.getElementById('monthPicker');
    const yearPicker    = document.getElementById('yearPicker');

    function buildPickers(){
      monthPicker.innerHTML=''; yearPicker.innerHTML='';
      for(let m=1;m<=12;m++){ const o=document.createElement('option'); o.value=m; o.textContent=`${m}月`; monthPicker.appendChild(o); }
      const y0 = (new Date()).getFullYear()-5;
      for(let y=y0; y<=y0+15; y++){ const o=document.createElement('option'); o.value=y; o.textContent=`${y}年`; yearPicker.appendChild(o); }
      syncPickers();
      monthPicker.addEventListener('change',()=>{ currentMonth.setMonth(parseInt(monthPicker.value,10)-1); renderCalendar(); });
      yearPicker.addEventListener('change',()=>{ currentMonth.setFullYear(parseInt(yearPicker.value,10)); renderCalendar(); });
    }
    function syncPickers(){
      monthPicker.value = (currentMonth.getMonth()+1);
      yearPicker.value  = currentMonth.getFullYear();
    }

    function renderWeekdays(){
      weekdayHeader.innerHTML='';
      ['日','月','火','水','木','金','土'].forEach(d=>{
        const el=document.createElement('div'); el.className='weekday'; el.textContent=d; weekdayHeader.appendChild(el);
      });
    }

    function renderCalendar(){
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay  = new Date(year, month+1, 0);
      const startDay = firstDay.getDay();
      const weekdaysOnly = document.getElementById('toggleWeekdays').checked;
      document.getElementById('calTitle').textContent = `${year}年 ${month+1}月`;
      syncPickers();

      calendarGrid.innerHTML='';
      const cells=[];

      if(!weekdaysOnly){
        for(let i=0;i<startDay;i++){ const blank=document.createElement('div'); blank.className='day'; calendarGrid.appendChild(blank); }
      }

      const buildCell=(d)=>{
        const date = new Date(year, month, d);
        const cell=document.createElement('div');
        cell.className='day';
        const dateLabel = document.createElement('div'); dateLabel.className='date'; dateLabel.innerHTML = `<span>${d}</span>`;
        if(fmtDate(date)===fmtDate(new Date())) cell.classList.add('today');
        const cellBody = document.createElement('div'); cellBody.className='cell-body';
        cell.dataset.date = fmtDate(date);
        cell.appendChild(dateLabel); cell.appendChild(cellBody);

        // DnD: 期限のみ更新（所要は維持）
        cell.addEventListener('dragover',(e)=>{ e.preventDefault(); cell.style.outline='2px dashed var(--primary)' });
        cell.addEventListener('dragleave',()=>{ cell.style.outline='' });
        cell.addEventListener('drop',(e)=>{
          e.preventDefault(); cell.style.outline='';
          const id = e.dataTransfer.getData('text/task-id');
          const t = tasks.find(x=>x.id===id); if(!t) return;
          const newEnd = parseYmd(cell.dataset.date);
          t.deadline = fmtDate(newEnd);
          t.updatedAt = Date.now();
          save(); renderAll();
        });
        return cell;
      };

      for(let d=1; d<=lastDay.getDate(); d++){
        const date = new Date(year, month, d);
        if(weekdaysOnly && (date.getDay()===0 || date.getDay()===6)) continue;
        const cell = buildCell(d);
        calendarGrid.appendChild(cell);
        cells[d]=cell;
      }

      const monthStart = new Date(year, month, 1);
      const monthEnd   = new Date(year, month+1, 0);

      const filtered = tasks.filter(taskMatchesFilter);

      for(const t of filtered){
        if(!t.deadline || !t.duration) continue;
        const end = parseYmd(t.deadline);
        if(!end || isNaN(end)) continue;
        const duration = clamp(parseInt(t.duration,10)||1, 1, 365);
        const start = addDays(end, -(duration-1));

        // ★ この月にまったくかからないタスクは描画しない
        if (end < monthStart || start > monthEnd) continue;

        // この月にかかる部分だけ描画
        const rangeStart = (start < monthStart) ? monthStart : start;
        const rangeEnd   = (end   > monthEnd)   ? monthEnd   : end;

        for(let d=rangeStart.getDate(); d<=rangeEnd.getDate(); d++){
          const date = new Date(year, month, d);
          if(weekdaysOnly && (date.getDay()===0 || date.getDay()===6)) continue;
          const cell = cells[d]; if(!cell) continue;

          const chip = document.createElement('div');
          chip.className = `task-chip priority-${t.priority||'中'} ${t.status==='処理済み'?'done':''}`;
          if(fmtDate(date)===fmtDate(start)) chip.classList.add('chip-start');
          if(fmtDate(date)===fmtDate(end))   chip.classList.add('chip-end');
          chip.draggable = true;
          chip.addEventListener('dragstart',(e)=>{ chip.classList.add('dragging'); e.dataTransfer.setData('text/task-id', t.id) });
          chip.addEventListener('dragend',()=> chip.classList.remove('dragging'));
          chip.title = `[${t.status}] ${t.taskName}（${t.category||''}）\n〆 ${t.deadline} / 所要 ${t.duration}`;
          chip.innerHTML = `<span class="dot" style="background:${ t.status==='処理済み' ? 'var(--ok)' : 'var(--primary)'}"></span><span>${t.taskName}</span>`;
          chip.addEventListener('click', ()=> openQuick(t));
          cell.querySelector('.cell-body').appendChild(chip);
        }
      }

      // オーバーフロー（正しい隠れ数で表示）
      calendarGrid.querySelectorAll('.cell-body').forEach(body=>{
        const showMax = 6;
        const total = body.children.length;
        if(total > showMax){
          const hidden = total - (showMax - 1);
          while(body.children.length > showMax - 1) body.removeChild(body.lastChild);
          const more = document.createElement('div'); more.className='overflow';
          more.textContent = `…他 ${hidden} 件`;
          body.appendChild(more);
        }
      });
    }

    // ===== Quick Edit =====
    const dlg = document.getElementById('quickDialog');
    let dlgEditingId = null;
    function openQuick(t){
      dlgEditingId = t.id;
      document.getElementById('qName').value     = t.taskName;
      document.getElementById('qStatus').value   = t.status;
      document.getElementById('qPriority').value = t.priority;
      document.getElementById('qDeadline').value = t.deadline;
      document.getElementById('qDuration').value = t.duration;
      document.getElementById('qNotes').value    = t.notes||'';
      dlg.showModal();
    }
    document.getElementById('qSave').addEventListener('click',()=>{
      const t = tasks.find(x=>x.id===dlgEditingId); if(!t) return;
      t.taskName = document.getElementById('qName').value.trim();
      t.status   = document.getElementById('qStatus').value;
      t.priority = document.getElementById('qPriority').value;
      t.deadline = document.getElementById('qDeadline').value;
      t.duration = clamp(parseInt(document.getElementById('qDuration').value||'1',10),1,365);
      t.notes    = document.getElementById('qNotes').value.trim();
      t.updatedAt= Date.now();
      save(); renderAll(); dlg.close();
    });
    document.getElementById('qDelete').addEventListener('click',()=>{
      if(confirm('削除しますか？')){ removeById(dlgEditingId); dlg.close(); }
    });

    // ===== Toolbar =====
    document.getElementById('btnAdd').addEventListener('click',()=>{
      form.reset(); document.getElementById('taskId').value='';
      document.getElementById('taskName').focus();
    });
    document.getElementById('btnExport').addEventListener('click',()=>{
      const blob = new Blob([JSON.stringify(tasks,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `tasks-${new Date().toISOString().slice(0,10)}.json`;
      a.click(); URL.revokeObjectURL(a.href);
    });
    document.getElementById('btnImport').addEventListener('click',()=> document.getElementById('filePicker').click());
    document.getElementById('filePicker').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text();
      try{
        const data = JSON.parse(text);
        if(!Array.isArray(data)) throw new Error('配列ではありません');
        tasks = data; save(); renderAll(); alert('インポート完了');
      }catch(err){ alert('インポート失敗: '+err.message) }
      finally{ e.target.value=''; }
    });
    document.getElementById('btnClear').addEventListener('click',()=>{
      if(confirm('全タスクを削除します。よろしいですか？')){ tasks=[]; save(); renderAll(); }
    });

    // ===== Calendar Nav =====
    document.getElementById('prevMonth').addEventListener('click',()=>{ currentMonth.setMonth(currentMonth.getMonth()-1); renderCalendar(); });
    document.getElementById('nextMonth').addEventListener('click',()=>{ currentMonth.setMonth(currentMonth.getMonth()+1); renderCalendar(); });
    document.getElementById('btnToday').addEventListener('click',()=>{ currentMonth = new Date(); renderCalendar(); });
    document.getElementById('toggleWeekdays').addEventListener('change',()=> renderCalendar());

    // ===== Boot =====
    function renderAll(){ renderTable(); renderWeekdays(); renderCalendar(); }
    function buildSeedIfEmpty(){
      if(tasks.length===0){
        const today = new Date();
        const sample=[
          {id:uid(),taskName:'要件整理',deadline:fmtDate(addDays(today,3)),priority:'高',duration:2,status:'未処理',category:'仕事',notes:''},
          {id:uid(),taskName:'見積作成',deadline:fmtDate(addDays(today,6)),priority:'中',duration:1,status:'処理中',category:'仕事',notes:'A社向け'},
          {id:uid(),taskName:'来月案件レビュー',deadline:fmtDate(new Date(today.getFullYear(), today.getMonth()+1, 5)),priority:'低',duration:1,status:'未処理',category:'仕事',notes:''}
        ];
        tasks = sample; save();
      }
    }
    // ===== Filters: bind events (missing wiring fix) =====
function bindFilters(){
  const ids = ['search','fltStatus','fltPriority','fltCategory'];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', renderAll);   // タイプ/選択の即時反映
    el.addEventListener('change', renderAll);  // セレクト確定時の反映
  });
}

    load(); buildSeedIfEmpty(); renderWeekdays(); buildPickers(); renderAll();bindFilters();
  </script>
</body>
</html>
